#!/bin/sh -ex
#
# http://github.com/mitchweaver
#
# quickly setup vnc on a remote server
#

export DISPLAY=:0

case $(uname) in
    OpenBSD)
        sudo=doas
        ;;
    *)
        sudo=sudo
esac

if ! command -v Xvfb >/dev/null || ! command -v x11vnc >/dev/null ; then

    if command -v pacman >/dev/null ; then
        $sudo pacman -Sy \
            x11vnc \
            xorg-xserver-xvfb \
            xfce4-desktop
    elif command -v apt >/dev/null ; then
        $sudo apt update
        $sudo apt install -y \
            tzdata ca-certificates dbus dbus-x11 \
            desktop-file-utils x11-xserver-utils \
            x11vnc xfce4-desktop
        $sudo apt install -y xvfb openbox python-minimal
    elif command -v apk >/dev/null ; then
        $sudo apk update
        $sudo apk add x11vnc xvfb xorg-server \
            xf86-input-mouse xf86-input-keyboard xset \
            xterm python2 xfce4-desktop
    fi
fi

if ! pgrep X >/dev/null ; then
    Xvfb -screen 0 1024x768x24 -ac &
    sleep 5
    echo 'Sleeping 5 seconds for Xvfb to settle.'
    if command -v xfce-session ; then
        xfce-session &
    else
        xfce4-session &
    fi
fi

xset m 0 0

nohup \
    x11vnc \
    -loop \
    -xkb \
    -nopw \
    -wait 5 \
    -noxrecord \
    -noxdamage \
    -permitfiletransfer \
    -tightfilexfer \
    -noxfixes \
    -forever \
    -shared \
    -rfbport 5900 \
    -display :0 &

echo
echo "forked!"
